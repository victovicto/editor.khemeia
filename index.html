<!DOCTYPE html> 
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <meta name="description" content="Editor Ketcher" />
  <title>Ketcher com Quiz</title>

  <link rel="stylesheet" href="static/css/main.aafe9c71.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      background-color: #ffffff;
      user-select: none;
      font-family: sans-serif;
    }

    #root {
      height: 100vh;
      width: 100vw;
    }

    .ketcher-topbar__group button[title="Convert structure"] {
      display: none !important;
    }

    #quiz-panel {
      display: none;
      position: absolute;
      top: 70px;
      right: 10px;
      width: 320px;
      background: white;
      border: 2px solid #6A1B9A;
      border-radius: 12px;
      padding: 15px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .quiz-button {
      background-color: #6A1B9A;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 8px;
      margin: 5px 0;
      cursor: pointer;
      width: 100%;
    }

    .quiz-button:hover {
      background-color: #4a106a;
    }

    .correct {
      background-color: #4CAF50 !important;
    }

    .incorrect {
      background-color: #F44336 !important;
    }

    #custom-save-button {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background-color: #6A1B9A;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>

  <script>
    window.ketcher = { server: { indigo: null } };
  </script>
  <script defer src="static/js/main.6127d62f.js"></script>

  <script>
    window.addEventListener('load', () => {
      const waitForKetcher = setInterval(() => {
        if (window.ketcher?.getMolfile && window.ketcher?.setMolecule) {
          clearInterval(waitForKetcher);

          const quizPanel = document.getElementById('quiz-panel');
          const quizContent = document.getElementById('quiz-content');

          let currentQuestionIndex = 0;
          let quizData = [];

          const renderQuestion = () => {
            if (!quizData[currentQuestionIndex]) return;
            const pergunta = quizData[currentQuestionIndex];
            quizContent.innerHTML = '';

            const title = document.createElement('h4');
            title.textContent = `Pergunta ${currentQuestionIndex + 1}: ${pergunta.enunciado}`;
            quizContent.appendChild(title);

            pergunta.alternativas.forEach((alt, i) => {
              const btn = document.createElement('button');
              btn.className = 'quiz-button';
              btn.textContent = `${String.fromCharCode(65 + i)}) ${alt}`;
              btn.addEventListener('click', () => {
                const correta = pergunta.resposta.toUpperCase().charCodeAt(0) - 65;
                if (i === correta) {
                  btn.classList.add('correct');
                } else {
                  btn.classList.add('incorrect');
                  quizContent.querySelectorAll('.quiz-button')[correta].classList.add('correct');
                }
                setTimeout(() => {
                  currentQuestionIndex++;
                  if (currentQuestionIndex < quizData.length) {
                    renderQuestion();
                  } else {
                    quizContent.innerHTML = '<p><strong>Quiz finalizado!</strong></p>';
                  }
                }, 1000);
              });
              quizContent.appendChild(btn);
            });
          };

          const getMolfileAndSend = async () => {
            try {
              const molfile = await window.ketcher.getMolfile();
              console.log(molfile); // Verifique o Molfile no console
              if (!molfile) {
                alert('Por favor, desenhe uma molécula.');
                return;
              }

              const res = await fetch('https://khemeia.onrender.com/ai/analisar-molecula', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ molfile }) // Enviando apenas o Molfile
              });

              const result = await res.json();

              quizData = result.perguntas || [];
              currentQuestionIndex = 0;
              if (quizData.length > 0) {
                quizPanel.style.display = 'block';
                renderQuestion();
              } else {
                quizContent.innerHTML = '<p>Nenhuma pergunta foi gerada.</p>';
                quizPanel.style.display = 'block';
              }
            } catch (err) {
              console.error('Erro ao obter perguntas do backend:', err);
              alert('Erro ao conectar ao backend. Tente novamente.');
            }
          };

          document.getElementById('custom-save-button').addEventListener('click', getMolfileAndSend);
        }
      }, 100);
    });
  </script>
</head>
<body>
  <noscript>Habilite o JavaScript para usar o Ketcher.</noscript>
  <div id="root"></div>

  <!-- Botão de salvar -->
  <button id="custom-save-button">Salvar & Gerar Perguntas</button>

  <!-- Painel de Quiz -->
  <div id="quiz-panel">
    <h3 style="margin-top: 0; color: #6A1B9A;">Quiz da Molécula</h3>
    <div id="quiz-content"></div>
    <button onclick="document.getElementById('quiz-panel').style.display='none'" style="margin-top: 10px; background-color: #ccc; border: none; border-radius: 6px; padding: 8px; width: 100%;">Fechar</button>
  </div>
</body>
</html>
